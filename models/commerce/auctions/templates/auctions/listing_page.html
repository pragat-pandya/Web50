{% extends "auctions/layout.html" %}

{% block body %}
<div class="container">
  <h1>{{title}}</h1>
  <div class="row content-justify-center text-center m-5 p-2">
    <img class="img-fluid" src="{{image}}" alt="No image is available for this listing" id="listing-page-image">
  </div>

  {% if user.is_authenticated %}
  <div>
    {% if flag %}
      <form action="{% url 'unwatch' %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="title" value="{{title}}">
        <input class="btn btn-outline-danger" type="submit" value="unwatch">
      </form>
    {% else %}
      <form action="{% url 'watch' %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="title" value="{{title}}">
        <input class="btn btn-outline-success" type="submit" value="watch">
      </form>
    {% endif %}  
  </div>
  {% endif %}
  
  <div class="p-1 m-4" id="curr_price">
      <h2>Initial Bid: <div>${{initial_bid}}</div></h2>
  </div>
  {% if isclosed %}
  <div class="p-1 m-4">
    <h2>The winner of this auctions is:</h2>
    <h3>{{winner.username}}</h3>
  </div>
  {% else %}
  <div class="p-1 m-4">
    <p><h2>Take part in Auction: </h2></p>
    <form action="{% url 'make a bid' %}" method="POST">
      {% csrf_token %}
      <input type="hidden" value="{{title}}" name="title">
      <input type="number" name="bid_amount">
      <input type="submit" class="ml-3 btn btn-outline-primary" value="Make a bid!">
    </form>
    {% if not bid_validity %}
      <p>Sorry, your bid must be grater than the current price of the item. Also you cannot bid on your own listing.</p>
    {% endif %}
  </div>
  {% endif %}
  <div class="p-1 m-4" id="curr_price">
    {% if price != None %}
      <h2>Current Price: <div>${{price}}</div></h2>
    {% else %}
      <h2>Current Price: <div>${{initial_bid}}</div></h2>
    {% endif %}
  </div>

  <div class="p-1 m-4">
    <p><h2>Bidding Details:</h2></p>
    {% if prev_bids %}
      {% for bid in bids %}
        <div>
          <ul>
            <li>${{bid.amount}} bidded by {{bid.usr.username}}</li>
          </ul>
        </div>
      {% endfor %}
    {% else %}
      <div>There are no previous bids be the first bidder!</div>
    {% endif %}
  </div>

  <div id="description" class="p-4 mt-4">
    <h2>Description</h2>
    <p>{{description}}</p>
  </div>

  {% if owner %}
  <div class="p-4 mt-4">
    {% if isclosed %}
      <div>This auction is closed by owner ({{listing.owner.username}})</div>
    {% else %}
    <form action="{% url 'close auction' %}" method="POST">
      {% csrf_token %}
      <input type="hidden" name="title" value="{{title}}">
      <input type="submit" value="Close the auction!" class="btn btn-outline-danger">
    </form>
    {% endif %}
  </div>
  {% endif %}
</div>

<div class="container mt-5">
  <h2>Comments</h2>
</div>


<!---Comment section-->
{% if iscomments %}
<div class="container mt-5">
  {% for comment in comments %}
  <div class="d-flex justify-content-center row">
      <div class="col-md-8">
          <div class="d-flex flex-column comment-section">
              <div class="bg-white p-2">
                  <div class="d-flex flex-row user-info"><img class="rounded-circle" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQAgrsY1Zw5553wtz3MX7Tm6FWm-1nGG-pENw&usqp=CAU" width="40">
                      <div class="d-flex flex-column justify-content-start ml-2"><span class="d-block font-weight-bold name">{{comment.usr.username}}</span></div>
                  </div>
                  <div class="mt-2">
                      <p class="comment-text">{{comment.body}}</p>
                  </div>
              </div>
          </div>
      </div>
  </div>
  {% endfor %}
  <div class="container mt-5">
    <div class="bg-white">
      <div class="d-flex flex-row fs-12">
        <p>Add your comment: </p>
      </div>
    </div>
    <div class="bg-light p-2">
      <div class="d-flex flex-row align-items-start"><img class="rounded-circle" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQAgrsY1Zw5553wtz3MX7Tm6FWm-1nGG-pENw&usqp=CAU" width="40"><textarea class="form-control ml-1 shadow-none textarea" form="cmnt" name="cbody"></textarea></div>
      <form action="{% url 'add comment' %}" id="cmnt" class="form" method="POST">
        {% csrf_token %}
        <input type="hidden" name="item-name" value="{{title}}">
        <div class="mt-2 text-right"><button class="btn btn-success btn-sm shadow-none" type="submit" form="cmnt" formaction="{% url 'add comment' %}" formmethod="POST">Post comment</button></div>
      </form>      
    </div>
  </div>
</div>

{% else %}
<div class="container mt-5">
  <div class="bg-white">
    <div class="d-flex flex-row fs-12">
      <p>Add your comment: </p>
    </div>
  </div>
  <div class="bg-light p-2">
    <div class="d-flex flex-row align-items-start"><img class="rounded-circle" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQAgrsY1Zw5553wtz3MX7Tm6FWm-1nGG-pENw&usqp=CAU" width="40"><textarea class="form-control ml-1 shadow-none textarea" form="cmnt" name="cbody"></textarea></div>
    <form action="{% url 'add comment' %}" id="cmnt" class="form" method="POST">
      {% csrf_token %}
      <input type="hidden" name="item-name" value="{{title}}">
      <div class="mt-2 text-right"><button class="btn btn-success btn-sm shadow-none" type="submit" form="cmnt" formaction="{% url 'add comment' %}" formmethod="POST">Post comment</button></div>
    </form>      
  </div>
</div>
{% endif %}
{% endblock %}